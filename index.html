<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KD Test App - Cloud Edition</title>
    
    <script src="https://www.gstatic.com/firebasejs/10.8.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.8.1/firebase-firestore-compat.js"></script>

    <style>
        /* ALL PREVIOUS CSS REMAINS EXACTLY THE SAME */
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: #f0f4f8; color: #333; display: flex; flex-direction: column; align-items: center; padding: 20px; margin: 0; min-height: 100vh; }
        .container { background: white; padding: 30px; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.08); width: 100%; max-width: 600px; margin-top: 20px; animation: fadeIn 0.4s ease-in-out; }
        .landing-container { text-align: center; margin-top: 10vh; }
        .hidden { display: none !important; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        input[type="text"], input[type="password"], input[type="number"], select, textarea, input[type="file"] { width: 100%; padding: 12px; margin: 8px 0 15px 0; border: 1px solid #ced4da; border-radius: 6px; box-sizing: border-box; font-size: 15px; font-family: inherit; }
        input[type="file"] { background: #f8f9fa; cursor: pointer; }
        input:focus, textarea:focus { outline: none; border-color: #0056b3; box-shadow: 0 0 5px rgba(0, 86, 179, 0.3); }
        .password-container { position: relative; width: 100%; }
        .password-container input { padding-right: 40px; }
        .toggle-password { position: absolute; right: 12px; top: 40%; transform: translateY(-50%); cursor: pointer; color: #6c757d; display: flex; align-items: center; justify-content: center; }

        button { background-color: #0056b3; color: white; border: none; padding: 12px 15px; border-radius: 6px; cursor: pointer; width: 100%; font-size: 16px; margin-top: 5px; transition: 0.2s; font-weight: 500; }
        button:hover { background-color: #004494; }
        button:disabled { background-color: #a0a0a0; cursor: not-allowed; }
        .btn-admin { background-color: #dc3545; } .btn-admin:hover { background-color: #c82333; }
        .btn-student { background-color: #28a745; margin-bottom: 15px; } .btn-student:hover { background-color: #218838; }
        .btn-secondary { background-color: #6c757d; } .btn-secondary:hover { background-color: #5a6268; }
        .btn-logout { background-color: #f8f9fa; color: #dc3545; border: 1px solid #dc3545; } .btn-logout:hover { background-color: #dc3545; color: white; }
        .btn-warning { background-color: #ffc107; color: #212529; } .btn-warning:hover { background-color: #e0a800; }

        .text-link { color: #0056b3; cursor: pointer; font-size: 14px; text-decoration: underline; margin-top: 15px; display: inline-block; }
        .error-text { color: #dc3545; font-size: 14px; margin-top: -10px; margin-bottom: 10px; display: none; }
        .success-text { color: #28a745; font-size: 14px; margin-top: 10px; display: none; text-align: center; font-weight: bold; }

        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.6); backdrop-filter: blur(4px); display: flex; justify-content: center; align-items: center; z-index: 1000; }
        .modal-box { background: white; padding: 30px; border-radius: 12px; box-shadow: 0 10px 30px rgba(0,0,0,0.3); width: 350px; text-align: center; }

        .header-bar { display: flex; justify-content: space-between; align-items: center; border-bottom: 2px solid #eee; padding-bottom: 15px; margin-bottom: 10px; }
        .section-title { font-size: 1.1em; color: #495057; border-bottom: 1px solid #dee2e6; padding-bottom: 5px; margin-bottom: 15px; }
        
        .tab-container { display: flex; gap: 10px; margin-bottom: 20px; border-bottom: 1px solid #dee2e6; padding-bottom: 10px; flex-wrap: wrap;}
        .tab-btn { background: transparent; color: #0056b3; border: 1px solid transparent; width: auto; padding: 8px 15px; font-size: 14px; margin: 0; border-radius: 20px; }
        .tab-btn.active { background: #e9ecef; color: #333; font-weight: bold; }
        .tab-btn:hover:not(.active) { background: #f8f9fa; }

        .list-item { display: flex; justify-content: space-between; align-items: center; background: #f8f9fa; padding: 15px; border-radius: 8px; border: 1px solid #e9ecef; margin-bottom: 10px; text-align: left; }
        .list-item button { width: auto; margin: 0; padding: 6px 12px; font-size: 13px; }

        .guidelines-box { background: #f8f9fa; border: 1px solid #ced4da; border-radius: 6px; padding: 10px; height: 100px; overflow-y: auto; text-align: left; font-size: 12px; color: #666; margin-bottom: 10px; }
        .checkbox-container { display: flex; align-items: center; gap: 10px; text-align: left; font-size: 14px; margin-bottom: 15px; cursor: pointer; }
        .checkbox-container input { width: auto; margin: 0; }

        .responsive-img { max-width: 100%; height: auto; max-height: 250px; border-radius: 8px; margin: 15px auto; display: block; box-shadow: 0 2px 10px rgba(0,0,0,0.1); cursor: zoom-in; }
        #lightboxModal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.85); z-index: 9999; display: flex; justify-content: center; align-items: center; cursor: zoom-out; }
        #lightboxImg { max-width: 95vw; max-height: 95vh; border-radius: 8px; box-shadow: 0 0 20px rgba(0,0,0,0.5); }

        .option-label { display: block; background: #f8f9fa; margin: 10px 0; padding: 12px; border-radius: 6px; cursor: pointer; border: 1px solid #e9ecef; transition: background-color 0.2s; }
        .option-label:hover { background: #e2e6ea; }
        .quiz-control-bar { display: flex; justify-content: space-between; align-items: center; background: #e9ecef; padding: 10px 15px; border-radius: 8px; margin-bottom: 20px; }
        .timer-display { font-size: 1.2em; font-weight: bold; color: #dc3545; font-family: monospace; }
        .pause-screen { text-align: center; padding: 40px 20px; background: #f8f9fa; border-radius: 8px; border: 2px dashed #ced4da; }
        
        .review-card { background: #fff; border: 1px solid #dee2e6; border-radius: 8px; padding: 15px; margin-bottom: 15px; text-align: left; }
        .review-option { padding: 10px; margin: 5px 0; border-radius: 4px; border: 1px solid #e9ecef; background: #f8f9fa; }
        .review-correct { background: #d4edda; border-color: #c3e6cb; color: #155724; font-weight: bold; }
        .review-wrong { background: #f8d7da; border-color: #f5c6cb; color: #721c24; text-decoration: line-through; }

        .rank-badge { background: #ffc107; color: #000; padding: 5px 10px; border-radius: 20px; font-weight: bold; font-size: 12px; }
        .rank-1 { background: #ffd700; } .rank-2 { background: #e3e4e5; } .rank-3 { background: #cd7f32; } 
    </style>
</head>
<body>

    <div id="lightboxModal" class="hidden" onclick="closeLightbox()">
        <img id="lightboxImg" src="">
    </div>

    <div id="landingPage" class="container landing-container">
        <h1 style="color: #0056b3; margin-top: 0;">KD Test Portal</h1>
        <p style="color: #666; margin-bottom: 10px;">Select your portal to continue.</p>
        <p id="cloudStatus" style="font-size: 12px; color: #dc3545; font-weight: bold; margin-bottom: 20px;">Connecting to Cloud Server...</p>

        <button class="btn-student" onclick="openModal('studentLoginModal')">Student Login</button>
        <button class="btn-admin" onclick="openModal('adminLoginModal')">Admin Access</button>
    </div>

    <div id="adminLoginModal" class="modal-overlay hidden">
        <div class="modal-box">
            <h3 style="color: #dc3545; margin-top: 0;">Admin Portal</h3>
            <div class="password-container">
                <input type="password" id="adminPasswordInput" placeholder="Passcode">
                <span class="toggle-password" onclick="toggleVisibility('adminPasswordInput')">üëÅÔ∏è</span>
            </div>
            <p id="adminError" class="error-text"></p>
            <button class="btn-admin" onclick="verifyAdmin()">Login</button>
            <button class="btn-secondary" onclick="closeModals()">Cancel</button>
        </div>
    </div>

    <div id="studentLoginModal" class="modal-overlay hidden">
        <div class="modal-box">
            <h3 style="color: #28a745; margin-top: 0;">Student Login</h3>
            <input type="number" id="loginId" placeholder="Student ID Number">
            <div class="password-container">
                <input type="password" id="loginPass" placeholder="Password">
                <span class="toggle-password" onclick="toggleVisibility('loginPass')">üëÅÔ∏è</span>
            </div>
            <p id="loginError" class="error-text"></p>
            <button class="btn-student" onclick="verifyStudent()">Login</button>
            <button class="btn-secondary" onclick="closeModals()">Cancel</button>
            <span class="text-link" onclick="openRegistration()">Don't have an ID? Create Account</span>
        </div>
    </div>

    <div id="registerModal" class="modal-overlay hidden">
        <div class="modal-box" style="width: 400px;">
            <h3 style="color: #0056b3; margin-top: 0;">Create Account</h3>
            <input type="text" id="regName" placeholder="Full Name (e.g., John Doe)">
            <input type="number" id="regId" placeholder="Create an ID Number (e.g., 101)">
            <div class="password-container">
                <input type="password" id="regPass" placeholder="Create a Password">
                <span class="toggle-password" onclick="toggleVisibility('regPass')">üëÅÔ∏è</span>
            </div>
            <p style="text-align: left; font-size: 13px; font-weight: bold; margin-bottom: 5px;">Community Guidelines:</p>
            <div id="regGuidelinesBox" class="guidelines-box">Loading guidelines...</div>
            <label class="checkbox-container">
                <input type="checkbox" id="acceptGuidelines" onchange="toggleRegButton()"> I accept the guidelines and rules.
            </label>
            <p id="regError" class="error-text"></p>
            <button id="regSubmitBtn" onclick="registerStudent()" disabled>Create Account</button>
            <button class="btn-secondary" onclick="switchModal('registerModal', 'studentLoginModal')">Back to Login</button>
        </div>
    </div>

    <div id="adminPanel" class="container hidden">
        <div class="header-bar">
            <h2 style="margin: 0; color: #dc3545;">KD Admin (Cloud)</h2>
            <button class="btn-logout" style="width: auto; padding: 8px 15px;" onclick="logout()">Logout</button>
        </div>

        <div class="tab-container" id="adminTabs">
            <button class="tab-btn active" onclick="switchAdminTab('adminAnalytics')">Analytics</button>
            <button class="tab-btn" onclick="switchAdminTab('adminTestManager')">Manage Tests</button>
            <button class="tab-btn" onclick="switchAdminTab('adminUserManager')">Users</button>
            <button class="tab-btn" onclick="switchAdminTab('adminSettings')">Settings</button>
        </div>

        <div id="adminAnalytics" class="admin-view">
            <h3 class="section-title">Global Test Scores</h3>
            <div id="adminAnalyticsList"></div>
        </div>

        <div id="adminTestManager" class="admin-view hidden">
            <h3 class="section-title">Create a New Test</h3>
            <div style="display: flex; gap: 10px; margin-bottom: 10px;">
                <input type="text" id="newTestName" placeholder="Test Name" style="margin: 0; flex-grow: 1;">
                <input type="number" id="newTestTimer" placeholder="Mins (0=None)" style="margin: 0; width: 120px;" min="0">
            </div>
            <button class="btn-admin" onclick="createNewTest()">Create Cloud Test</button>
            <h3 class="section-title" style="margin-top: 25px;">Live Cloud Tests</h3>
            <div id="adminTestList"></div>
        </div>

        <div id="adminQuestionEditor" class="admin-view hidden">
            <button class="btn-secondary" style="margin-bottom: 15px; width: auto; font-size: 14px; padding: 5px 10px;" onclick="switchAdminTab('adminTestManager')">‚Üê Back to Tests</button>
            <h3 class="section-title" id="editingTestTitle" style="color: #0056b3;">Adding Questions to: </h3>
            
            <input type="text" id="qText" placeholder="Enter your question text...">
            
            <label style="font-size: 13px; color: #666; font-weight: bold;">Attach Photo (Keep images small to save cloud space):</label>
            <input type="file" id="qImageUpload" accept="image/*">
            <input type="hidden" id="qImageBase64"> 
            <img id="imagePreview" class="responsive-img hidden" src="" alt="Preview">

            <input type="text" id="opt0" placeholder="Option 1">
            <input type="text" id="opt1" placeholder="Option 2">
            <input type="text" id="opt2" placeholder="Option 3">
            <input type="text" id="opt3" placeholder="Option 4">
            
            <label for="correctAnswer" style="display: block; margin-top: 10px; font-weight: bold;">Correct Answer:</label>
            <select id="correctAnswer">
                <option value="0">Option 1</option><option value="1">Option 2</option><option value="2">Option 3</option><option value="3">Option 4</option>
            </select>

            <div style="display: flex; gap: 10px; margin-top: 15px;">
                <button id="saveQuestionBtn" class="btn-admin" style="margin: 0;" onclick="addQuestionToTest()">Sync to Cloud</button>
                <button id="cancelEditBtn" class="btn-secondary hidden" style="margin: 0; width: auto;" onclick="cancelEdit()">Cancel</button>
            </div>
            <p id="adminMessage" style="color: #28a745; font-weight: bold; text-align: center;"></p>

            <h3 class="section-title" style="margin-top: 30px;">Questions in this Test</h3>
            <div id="adminExistingQuestionsList"></div>
        </div>

        <div id="adminUserManager" class="admin-view hidden">
            <h3 class="section-title">Global Enrolled Students</h3>
            <div id="adminUserList"></div>
        </div>

        <div id="adminSettings" class="admin-view hidden">
            <h3 class="section-title">Change Admin Passcode</h3>
            <input type="password" id="newAdminPass" placeholder="New Passcode">
            <button class="btn-admin" onclick="updateAdminPassword()">Update Cloud Passcode</button>
            <p id="adminPassMsg" class="success-text"></p>

            <h3 class="section-title" style="margin-top: 30px;">Edit Registration Guidelines</h3>
            <textarea id="editGuidelinesText" rows="5"></textarea>
            <button class="btn-admin" onclick="saveAdminGuidelines()">Save to Cloud</button>
            <p id="guidelineMsg" class="success-text"></p>
        </div>
    </div>

    <div id="userPanel" class="container hidden">
        <div class="header-bar">
            <h2 style="margin: 0; color: #28a745;">KD Student (Cloud)</h2>
            <button class="btn-logout" style="width: auto; padding: 8px 15px;" onclick="logout()">Logout</button>
        </div>
        
        <div class="tab-container" id="studentTabs">
            <button class="tab-btn active" onclick="switchStudentTab('studentTestSelector')">My Tests</button>
            <button class="tab-btn" onclick="switchStudentTab('studentLeaderboard')">Leaderboards</button>
            <button class="tab-btn" onclick="switchStudentTab('studentSettings')">Settings</button>
        </div>

        <div id="studentTestSelector" class="student-view">
            <p id="welcomeMessage" style="color: #666; font-size: 18px; font-weight: bold; margin-top: 0;"></p>
            <h3 class="section-title">Available Cloud Tests</h3>
            <div id="studentTestList"></div>
        </div>

        <div id="studentLeaderboard" class="student-view hidden">
            <h3 class="section-title">Global Rankings</h3>
            <select id="leaderboardTestSelect" onchange="renderLeaderboardData()"><option value="">Select a test...</option></select>
            <div id="leaderboardResults" style="margin-top: 20px;"></div>
        </div>

        <div id="studentSettings" class="student-view hidden">
            <h3 class="section-title">Change My Password</h3>
            <input type="password" id="newStudentPass" placeholder="Enter New Password">
            <button class="btn-student" onclick="updateStudentPassword()">Update Password</button>
            <p id="studentPassMsg" class="success-text"></p>
        </div>

        <div id="quizContainer" class="student-view hidden">
            <div class="quiz-control-bar">
                <div>
                    <span style="font-size: 12px; color: #666; display: block;">Time Remaining</span>
                    <span id="timerDisplay" class="timer-display">--:--</span>
                </div>
                <div style="display: flex; gap: 5px;">
                    <button id="pauseBtn" class="btn-warning" style="width: auto; padding: 6px 12px; margin: 0; font-size: 14px;" onclick="togglePause()">Pause</button>
                    <button class="btn-admin" style="width: auto; padding: 6px 12px; margin: 0; font-size: 14px;" onclick="submitTestEarly()">Finish</button>
                </div>
            </div>

            <h3 id="activeQuizTitle" class="section-title" style="color: #0056b3; margin-top: 0;"></h3>
            
            <div id="pauseScreen" class="pause-screen hidden">
                <h2>Test Paused</h2><button class="btn-student" style="width: auto; padding: 10px 20px; font-size: 18px;" onclick="togglePause()">Resume Test</button>
            </div>

            <div id="quizContent">
                <p id="questionDisplay" style="font-size: 1.2em; font-weight: bold;">Loading question...</p>
                <img id="questionImageDisplay" class="responsive-img hidden" src="" alt="Question Image" onclick="openLightbox(this.src)">
                <p id="enlargeHint" class="hidden" style="text-align: center; font-size: 11px; color: #888; margin-top: -10px;">(Click image to enlarge)</p>
                
                <div id="optionsDisplay"></div>
                
                <div style="display: flex; justify-content: space-between; margin-top: 20px;">
                    <button id="prevBtn" class="btn-secondary" style="width: 48%;" onclick="navigateQuestion(-1)">Previous</button>
                    <button id="nextBtn" class="btn-student" style="width: 48%; margin: 0;" onclick="navigateQuestion(1)">Next</button>
                </div>
            </div>
        </div>
        
        <div id="resultContainer" class="student-view hidden" style="text-align: center;">
            <h2 id="scoreDisplay" style="color: #0056b3; font-size: 2.5em; margin-bottom: 0;"></h2>
            <p id="scorePercentage" style="color: #666; font-weight: bold; margin-top: 5px;"></p>
            <h3 class="section-title" style="margin-top: 30px;">Test Review</h3>
            <div id="reviewList"></div>
            <button class="btn-student" style="margin-top: 20px;" onclick="switchStudentTab('studentTestSelector')">Return to Dashboard</button>
        </div>
    </div>

    <script>
        // ==========================================
        // 1. FIREBASE CLOUD SETUP 
        // ==========================================
        
        // üî• PASTE YOUR FIREBASE CONFIG OBJECT HERE üî•
        const firebaseConfig = {
            // It will look like this:
            // apiKey: "AIzaSyB1x...",
            // authDomain: "kd-test-app.firebaseapp.com",
            // projectId: "kd-test-app",
            // storageBucket: "kd-test-app.appspot.com",
            // messagingSenderId: "123456789",
            // appId: "1:123456789:web:abcdefg"
        };

        // Initialize Cloud Database
        let db;
        try {
            firebase.initializeApp(firebaseConfig);
            db = firebase.firestore();
            document.getElementById('cloudStatus').innerText = "‚úÖ Connected to Cloud Database";
            document.getElementById('cloudStatus').style.color = "#28a745";
        } catch (error) {
            document.getElementById('cloudStatus').innerText = "‚ö†Ô∏è Missing Firebase Config! Please add your keys to the code.";
        }

        // ==========================================
        // 2. GLOBAL DATA & SYNCING 
        // ==========================================
        let allTests = []; 
        let userDatabase = []; 
        let studentScores = []; 
        let adminPasscode = "98133";
        let defaultGuide = "1. Be respectful to others.\n2. Do not cheat on tests.\n3. Admins reserve the right to remove accounts.";
        let appGuidelines = defaultGuide;
        
        let currentUserId = null;
        let activeAdminTestId = null; let editingQuestionIndex = null; 
        let activeStudentTestId = null; let currentQuestionIndex = 0; let userAnswers = [];
        let testTimerInterval; let timeRemainingSeconds = 0; let isPaused = false;

        // üî• THE MAGIC FUNCTION: Real-Time Sync üî•
        if (db) {
            db.collection("kd_app").doc("global_data").onSnapshot((doc) => {
                if (doc.exists) {
                    const data = doc.data();
                    allTests = data.allTests ? JSON.parse(data.allTests) : [];
                    userDatabase = data.userDatabase ? JSON.parse(data.userDatabase) : [];
                    studentScores = data.studentScores ? JSON.parse(data.studentScores) : [];
                    adminPasscode = data.adminPass || "98133";
                    appGuidelines = data.guidelines || defaultGuide;

                    // Instantly update screens if people are looking at them
                    if (!document.getElementById('adminTestManager').classList.contains('hidden')) renderAdminTestList();
                    if (!document.getElementById('adminAnalytics').classList.contains('hidden')) renderAdminAnalytics();
                    if (!document.getElementById('studentTestSelector').classList.contains('hidden')) renderStudentTestList();
                    if (!document.getElementById('studentLeaderboard').classList.contains('hidden')) renderLeaderboardData();
                }
            });
        }

        // OVERWRITE PREVIOUS SAVEDATA TO PUSH TO CLOUD INSTEAD OF LOCAL
        function saveData() {
            if (!db) return alert("Cannot save. Firebase is not connected.");
            
            // Notice: We are putting all data into one cloud document to keep things simple.
            // WARNING: If you upload too many heavy images, this document will hit Google's 1MB limit.
            db.collection("kd_app").doc("global_data").set({
                allTests: JSON.stringify(allTests),
                userDatabase: JSON.stringify(userDatabase),
                studentScores: JSON.stringify(studentScores),
                adminPass: adminPasscode,
                guidelines: appGuidelines
            }).catch(error => {
                console.error("Cloud Error:", error);
                alert("Error syncing to cloud. The data might be too large.");
            });
        }

        // --- LIGHTBOX CONTROLS ---
        function openLightbox(src) { document.getElementById('lightboxImg').src = src; document.getElementById('lightboxModal').classList.remove('hidden'); }
        function closeLightbox() { document.getElementById('lightboxModal').classList.add('hidden'); }

        // --- CLIENT-SIDE IMAGE COMPRESSION ---
        document.getElementById('qImageUpload').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (!file) { resetImageUpload(); return; }
            
            const reader = new FileReader();
            reader.onload = function(event) {
                const img = new Image();
                img.onload = function() {
                    const canvas = document.createElement('canvas');
                    const MAX_WIDTH = 600; // Shrink to 600px to save precious Cloud DB space!
                    let width = img.width; let height = img.height;
                    if (width > MAX_WIDTH) { height *= MAX_WIDTH / width; width = MAX_WIDTH; }
                    canvas.width = width; canvas.height = height;
                    const ctx = canvas.getContext('2d'); ctx.drawImage(img, 0, 0, width, height);
                    
                    // Compress heavily to keep the Cloud Database from crashing
                    const compressedDataUrl = canvas.toDataURL('image/jpeg', 0.5); 
                    
                    document.getElementById('qImageBase64').value = compressedDataUrl;
                    document.getElementById('imagePreview').src = compressedDataUrl;
                    document.getElementById('imagePreview').classList.remove('hidden');
                }
                img.src = event.target.result;
            };
            reader.readAsDataURL(file);
        });

        function resetImageUpload() { document.getElementById('qImageUpload').value = ""; document.getElementById('qImageBase64').value = ""; document.getElementById('imagePreview').src = ""; document.getElementById('imagePreview').classList.add('hidden'); }

        // --- UTILS ---
        function toggleVisibility(inputId) { const field = document.getElementById(inputId); field.type = field.type === "password" ? "text" : "password"; }
        function openModal(modalId) { document.querySelectorAll('.error-text, .success-text').forEach(el => el.style.display = 'none'); document.getElementById(modalId).classList.remove('hidden'); }
        function closeModals() { document.querySelectorAll('.modal-overlay').forEach(el => el.classList.add('hidden')); document.querySelectorAll('input[type="password"], input[type="number"], input[type="text"]').forEach(el => { if(el.id !== 'qText' && !el.id.startsWith('opt')) el.value = ''; }); }
        function switchModal(closeId, openId) { document.getElementById(closeId).classList.add('hidden'); openModal(openId); }
        function showSuccess(elementId, msg) { document.getElementById(elementId).innerText = msg; document.getElementById(elementId).style.display = 'block'; setTimeout(() => document.getElementById(elementId).style.display = 'none', 3000); }

        function switchAdminTab(viewId) {
            document.querySelectorAll('#adminPanel .admin-view').forEach(el => el.classList.add('hidden'));
            document.querySelectorAll('#adminTabs .tab-btn').forEach(el => el.classList.remove('active'));
            document.getElementById(viewId).classList.remove('hidden'); event.target.classList.add('active');
            
            if(viewId === 'adminAnalytics') renderAdminAnalytics();
            if(viewId === 'adminTestManager') renderAdminTestList();
            if(viewId === 'adminUserManager') renderAdminUserList();
            if(viewId === 'adminSettings') document.getElementById('editGuidelinesText').value = appGuidelines;
        }

        function switchStudentTab(viewId) {
            document.querySelectorAll('#userPanel .student-view').forEach(el => el.classList.add('hidden'));
            document.querySelectorAll('#studentTabs .tab-btn').forEach(el => el.classList.remove('active'));
            document.getElementById(viewId).classList.remove('hidden'); 
            if(event) event.target.classList.add('active'); 
            
            if(viewId === 'studentTestSelector') renderStudentTestList();
            if(viewId === 'studentLeaderboard') populateLeaderboardDropdown();
        }

        // --- AUTH & REGISTRATION ---
        function verifyAdmin() {
            if (document.getElementById('adminPasswordInput').value === adminPasscode) {
                closeModals();
                document.getElementById('landingPage').classList.add('hidden'); document.getElementById('adminPanel').classList.remove('hidden');
                renderAdminAnalytics(); 
            } else { document.getElementById('adminError').innerText = "Incorrect passcode."; document.getElementById('adminError').style.display = 'block'; }
        }

        function openRegistration() {
            document.getElementById('regGuidelinesBox').innerText = appGuidelines; document.getElementById('acceptGuidelines').checked = false; document.getElementById('regSubmitBtn').disabled = true;
            switchModal('studentLoginModal', 'registerModal');
        }
        function toggleRegButton() { document.getElementById('regSubmitBtn').disabled = !document.getElementById('acceptGuidelines').checked; }

        function registerStudent() {
            const name = document.getElementById('regName').value.trim(); const id = document.getElementById('regId').value; const pass = document.getElementById('regPass').value;
            if (!name || !id || !pass) { document.getElementById('regError').innerText = "Fill all fields."; return document.getElementById('regError').style.display = 'block'; }
            if (userDatabase.find(user => user.id === id)) { document.getElementById('regError').innerText = "ID taken."; return document.getElementById('regError').style.display = 'block'; }
            userDatabase.push({ id: id, name: name, pass: pass }); saveData(); 
            switchModal('registerModal', 'studentLoginModal'); document.getElementById('loginId').value = id; alert("Account saved to cloud! You can now log in.");
        }

        function verifyStudent() {
            const id = document.getElementById('loginId').value; const pass = document.getElementById('loginPass').value;
            const user = userDatabase.find(u => u.id === id && u.pass === pass);
            if (user) {
                currentUserId = user.id; closeModals();
                document.getElementById('landingPage').classList.add('hidden'); document.getElementById('userPanel').classList.remove('hidden');
                document.getElementById('welcomeMessage').innerText = `Welcome back, ${user.name}!`; renderStudentTestList(); 
            } else { document.getElementById('loginError').innerText = "Incorrect ID or Password."; document.getElementById('loginError').style.display = 'block'; }
        }

        function logout() {
            clearInterval(testTimerInterval); currentUserId = null; closeModals();
            document.getElementById('adminPanel').classList.add('hidden'); document.getElementById('userPanel').classList.add('hidden'); document.getElementById('landingPage').classList.remove('hidden');
        }

        // --- ADMIN FEATURES ---
        function renderAdminAnalytics() {
            const listDiv = document.getElementById('adminAnalyticsList');
            if (studentScores.length === 0) return listDiv.innerHTML = '<p style="color: #666; font-style: italic;">No test scores recorded yet.</p>';
            listDiv.innerHTML = ''; 
            const sortedScores = [...studentScores].reverse();
            sortedScores.forEach(record => {
                const percentage = Math.round((record.score / record.total) * 100);
                const color = percentage >= 70 ? '#28a745' : '#dc3545';
                listDiv.innerHTML += `
                    <div class="list-item" style="align-items: flex-start;">
                        <div>
                            <strong>${record.studentName}</strong> <span style="font-size: 12px; color: #666;">(ID: ${record.studentId})</span><br>
                            <span style="font-size: 13px; color: #0056b3; font-weight: bold;">üìù ${record.testName}</span><br>
                            <span style="font-size: 11px; color: #999;">${record.date}</span>
                        </div>
                        <div style="text-align: right;"><span style="font-size: 1.3em; font-weight: bold; color: ${color};">${percentage}%</span><br><span style="font-size: 12px; color: #666;">${record.score} / ${record.total}</span></div>
                    </div>`;
            });
        }

        function createNewTest() {
            const testName = document.getElementById('newTestName').value.trim(); const timer = parseInt(document.getElementById('newTestTimer').value) || 0;
            if (!testName) return alert("Please enter a test name.");
            allTests.push({ id: "test_" + Date.now(), name: testName, timeLimit: timer, questions: [] });
            saveData(); document.getElementById('newTestName').value = ''; document.getElementById('newTestTimer').value = ''; renderAdminTestList();
        }

        function renderAdminTestList() {
            const listDiv = document.getElementById('adminTestList');
            if (allTests.length === 0) return listDiv.innerHTML = '<p style="color: #666; font-style: italic;">No tests created yet.</p>';
            listDiv.innerHTML = ''; 
            allTests.forEach(test => {
                const timeText = test.timeLimit > 0 ? `${test.timeLimit}m` : "No Limit";
                listDiv.innerHTML += `
                    <div class="list-item">
                        <div><strong>${test.name}</strong><br><span style="font-size: 12px; color: #666;">${test.questions.length} Qs | ‚è±Ô∏è ${timeText}</span></div>
                        <div style="display: flex; gap: 5px;">
                            <button class="btn-admin" style="background:#28a745;" onclick="openTestEditor('${test.id}')">Manage</button>
                            <button class="btn-admin" onclick="deleteTest('${test.id}')">Del</button>
                        </div>
                    </div>`;
            });
        }

        function deleteTest(testId) {
            if (confirm("WARNING: Are you sure you want to delete this test globally?")) {
                allTests = allTests.filter(t => t.id !== testId); studentScores = studentScores.filter(s => s.testId !== testId); saveData(); renderAdminTestList();
            }
        }

        function openTestEditor(testId) {
            activeAdminTestId = testId; document.getElementById('editingTestTitle').innerText = `Editing: ${allTests.find(t => t.id === testId).name}`;
            document.querySelectorAll('.admin-view').forEach(el => el.classList.add('hidden')); document.getElementById('adminQuestionEditor').classList.remove('hidden');
            cancelEdit(); renderAdminQuestionList(); 
        }

        function renderAdminQuestionList() {
            const listDiv = document.getElementById('adminExistingQuestionsList'); const activeTest = allTests.find(t => t.id === activeAdminTestId);
            if (activeTest.questions.length === 0) return listDiv.innerHTML = '<p style="color: #666; font-style: italic;">No questions added yet.</p>';
            listDiv.innerHTML = '';
            activeTest.questions.forEach((q, i) => {
                const imgBadge = q.image ? `<span style="font-size:10px; background:#e9ecef; padding:2px 5px; border-radius:4px; margin-left:5px;">üñºÔ∏è Has Image</span>` : "";
                listDiv.innerHTML += `
                    <div class="list-item">
                        <div style="flex-grow: 1; margin-right: 15px;"><strong style="color:#0056b3;">Q${i+1}:</strong> ${q.question} ${imgBadge}</div>
                        <div style="display: flex; gap: 5px; min-width: 120px;">
                            <button class="btn-secondary" style="padding: 5px 10px; font-size: 13px;" onclick="editQuestion(${i})">Edit</button>
                            <button class="btn-admin" style="padding: 5px 10px; font-size: 13px;" onclick="deleteQuestion(${i})">Del</button>
                        </div>
                    </div>`;
            });
        }

        function editQuestion(i) {
            const q = allTests.find(t => t.id === activeAdminTestId).questions[i];
            document.getElementById('qText').value = q.question; document.getElementById('opt0').value = q.options[0]; document.getElementById('opt1').value = q.options[1]; document.getElementById('opt2').value = q.options[2]; document.getElementById('opt3').value = q.options[3]; document.getElementById('correctAnswer').value = q.correctIndex;
            if (q.image) { document.getElementById('qImageBase64').value = q.image; document.getElementById('imagePreview').src = q.image; document.getElementById('imagePreview').classList.remove('hidden'); } else { resetImageUpload(); }
            editingQuestionIndex = i; document.getElementById('saveQuestionBtn').innerText = "Update"; document.getElementById('saveQuestionBtn').style.backgroundColor = "#28a745"; document.getElementById('cancelEditBtn').classList.remove('hidden');
        }
        function cancelEdit() { editingQuestionIndex = null; document.getElementById('saveQuestionBtn').innerText = "Sync to Cloud"; document.getElementById('saveQuestionBtn').style.backgroundColor = "#dc3545"; document.getElementById('cancelEditBtn').classList.add('hidden'); document.getElementById('qText').value = ''; document.getElementById('opt0').value = ''; document.getElementById('opt1').value = ''; document.getElementById('opt2').value = ''; document.getElementById('opt3').value = ''; document.getElementById('correctAnswer').value = '0'; resetImageUpload(); }
        function deleteQuestion(i) { if(confirm("Delete this question globally?")) { allTests.find(t => t.id === activeAdminTestId).questions.splice(i, 1); saveData(); renderAdminQuestionList(); if(editingQuestionIndex === i) cancelEdit(); } }
        
        function addQuestionToTest() {
            const q = document.getElementById('qText').value; const options = [document.getElementById('opt0').value, document.getElementById('opt1').value, document.getElementById('opt2').value, document.getElementById('opt3').value]; const ans = document.getElementById('correctAnswer').value;
            const imgData = document.getElementById('qImageBase64').value;
            if (!q || options.includes("")) return alert("Fill question text and all 4 options!");
            
            const activeTest = allTests.find(t => t.id === activeAdminTestId); 
            const obj = { question: q, options: options, correctIndex: parseInt(ans), image: imgData };
            
            if (editingQuestionIndex !== null) { activeTest.questions[editingQuestionIndex] = obj; showSuccess('adminMessage', "Updated!"); cancelEdit(); } 
            else { activeTest.questions.push(obj); showSuccess('adminMessage', "Saved to Cloud!"); cancelEdit(); }
            saveData(); renderAdminQuestionList();
        }

        function renderAdminUserList() {
            const listDiv = document.getElementById('adminUserList');
            if (userDatabase.length === 0) return listDiv.innerHTML = '<p style="color: #666; font-style: italic;">No students enrolled yet.</p>';
            listDiv.innerHTML = ''; 
            userDatabase.forEach((user, i) => { listDiv.innerHTML += `<div class="list-item"><div><strong>${user.name}</strong> <br><span style="color:#666; font-size:12px;">ID: ${user.id}</span></div><button class="btn-admin" onclick="deleteUser(${i})">Remove</button></div>`; });
        }
        function deleteUser(i) { if(confirm(`Remove ${userDatabase[i].name} globally?`)) { userDatabase.splice(i, 1); saveData(); renderAdminUserList(); } }
        function updateAdminPassword() { const p = document.getElementById('newAdminPass').value; if(!p) return alert("Enter passcode."); adminPasscode = p; saveData(); document.getElementById('newAdminPass').value = ''; showSuccess('adminPassMsg', "Passcode updated in cloud!"); }
        function saveAdminGuidelines() { appGuidelines = document.getElementById('editGuidelinesText').value; saveData(); showSuccess('guidelineMsg', "Guidelines synced to cloud!"); }

        // --- STUDENT TEST LOGIC ---
        function renderStudentTestList() {
            const listDiv = document.getElementById('studentTestList');
            const playableTests = allTests.filter(t => t.questions.length > 0);
            if (playableTests.length === 0) return listDiv.innerHTML = '<p style="color: #666; font-style: italic;">No tests currently available.</p>';
            listDiv.innerHTML = ''; 
            playableTests.forEach(test => {
                const timeText = (test.timeLimit && test.timeLimit > 0) ? `${test.timeLimit}m` : "No Limit";
                listDiv.innerHTML += `<div class="list-item"><div><strong>${test.name}</strong><br><span style="font-size:12px; color:#666;">‚è±Ô∏è ${timeText}</span></div><button class="btn-student" onclick="startQuiz('${test.id}')">Start</button></div>`;
            });
        }

        function populateLeaderboardDropdown() {
            const select = document.getElementById('leaderboardTestSelect');
            select.innerHTML = '<option value="">Select a test to view rankings...</option>';
            const testsWithScores = [...new Set(studentScores.map(s => s.testId))];
            testsWithScores.forEach(testId => {
                const testObj = allTests.find(t => t.id === testId);
                if (testObj) { select.innerHTML += `<option value="${testId}">${testObj.name}</option>`; }
            });
            document.getElementById('leaderboardResults').innerHTML = ''; 
        }

        function renderLeaderboardData() {
            const testId = document.getElementById('leaderboardTestSelect').value; const resultsDiv = document.getElementById('leaderboardResults');
            if (!testId) { resultsDiv.innerHTML = ''; return; }

            let scoresForTest = studentScores.filter(s => s.testId === testId); let highestScores = {};
            scoresForTest.forEach(s => { if (!highestScores[s.studentId] || highestScores[s.studentId].score < s.score) { highestScores[s.studentId] = s; } });
            let rankedArray = Object.values(highestScores).sort((a, b) => b.score - a.score);

            resultsDiv.innerHTML = '';
            rankedArray.forEach((record, index) => {
                const rank = index + 1; const percentage = Math.round((record.score / record.total) * 100);
                let rankClass = "rank-badge "; if(rank === 1) rankClass += "rank-1"; else if(rank === 2) rankClass += "rank-2"; else if(rank === 3) rankClass += "rank-3"; else rankClass = "rank-badge";
                const isMe = record.studentId === currentUserId ? 'border-left: 4px solid #28a745; background: #e9ecef;' : '';
                resultsDiv.innerHTML += `
                    <div class="list-item" style="${isMe}">
                        <div style="display: flex; align-items: center; gap: 15px;"><span class="${rankClass}">#${rank}</span><div><strong>${record.studentName}</strong> ${record.studentId === currentUserId ? '<span style="color:#28a745; font-size:12px;">(You)</span>' : ''}</div></div>
                        <div style="text-align: right; font-weight: bold; color: #0056b3;">${percentage}% <br><span style="font-size: 11px; color: #666; font-weight: normal;">${record.score}/${record.total} Correct</span></div>
                    </div>`;
            });
        }

        function updateStudentPassword() { const p = document.getElementById('newStudentPass').value; if(!p) return alert("Enter password."); const idx = userDatabase.findIndex(u => u.id === currentUserId); userDatabase[idx].pass = p; saveData(); document.getElementById('newStudentPass').value = ''; showSuccess('studentPassMsg', "Password updated in cloud!"); }

        function startQuiz(testId) {
            activeStudentTestId = testId; const activeTest = allTests.find(t => t.id === activeStudentTestId);
            currentQuestionIndex = 0; userAnswers = new Array(activeTest.questions.length).fill(null); isPaused = false;
            document.getElementById('pauseScreen').classList.add('hidden'); document.getElementById('quizContent').classList.remove('hidden'); document.getElementById('pauseBtn').innerText = "Pause";
            document.querySelectorAll('.student-view').forEach(el => el.classList.add('hidden')); document.getElementById('quizContainer').classList.remove('hidden'); document.getElementById('activeQuizTitle').innerText = `${activeTest.name}`;
            renderQuestion(); startTimer(activeTest.timeLimit);
        }

        function startTimer(minutes) {
            clearInterval(testTimerInterval); const display = document.getElementById('timerDisplay');
            if (!minutes || minutes <= 0) { display.innerText = "No Limit"; display.style.color = "#28a745"; return; }
            timeRemainingSeconds = minutes * 60; display.style.color = "#dc3545"; updateTimerUI();
            testTimerInterval = setInterval(() => { if (!isPaused) { timeRemainingSeconds--; updateTimerUI(); if (timeRemainingSeconds <= 0) { clearInterval(testTimerInterval); alert("Time's up!"); processTestResults(); } } }, 1000);
        }
        function updateTimerUI() { let m = Math.floor(timeRemainingSeconds / 60); let s = timeRemainingSeconds % 60; document.getElementById('timerDisplay').innerText = `${m}:${s < 10 ? '0' : ''}${s}`; }
        function togglePause() {
            const activeTest = allTests.find(t => t.id === activeStudentTestId);
            if(!activeTest.timeLimit || activeTest.timeLimit <= 0) return alert("No time limit to pause.");
            isPaused = !isPaused; const btn = document.getElementById('pauseBtn');
            if(isPaused) { document.getElementById('quizContent').classList.add('hidden'); document.getElementById('pauseScreen').classList.remove('hidden'); btn.innerText = "Resume"; btn.classList.replace('btn-warning', 'btn-student'); } 
            else { document.getElementById('quizContent').classList.remove('hidden'); document.getElementById('pauseScreen').classList.add('hidden'); btn.innerText = "Pause"; btn.classList.replace('btn-student', 'btn-warning'); }
        }

        function renderQuestion() {
            const activeTest = allTests.find(t => t.id === activeStudentTestId); const currentQ = activeTest.questions[currentQuestionIndex];
            document.getElementById('questionDisplay').innerText = `Q${currentQuestionIndex + 1} of ${activeTest.questions.length}: ${currentQ.question}`;
            
            const imgDisplay = document.getElementById('questionImageDisplay'); const hintDisplay = document.getElementById('enlargeHint');
            if (currentQ.image && currentQ.image !== "") { imgDisplay.src = currentQ.image; imgDisplay.classList.remove('hidden'); hintDisplay.classList.remove('hidden'); } 
            else { imgDisplay.src = ""; imgDisplay.classList.add('hidden'); hintDisplay.classList.add('hidden'); }

            const optionsDiv = document.getElementById('optionsDisplay'); optionsDiv.innerHTML = ""; 
            currentQ.options.forEach((opt, index) => {
                const isChecked = userAnswers[currentQuestionIndex] === index ? "checked" : "";
                optionsDiv.innerHTML += `<label class="option-label"><input type="radio" name="quizOption" value="${index}" ${isChecked} onchange="userAnswers[${currentQuestionIndex}] = ${index}"> ${opt}</label>`;
            });
            document.getElementById('prevBtn').disabled = currentQuestionIndex === 0;
            if (currentQuestionIndex === activeTest.questions.length - 1) { document.getElementById('nextBtn').innerText = "Finish Test"; document.getElementById('nextBtn').classList.replace('btn-student', 'btn-admin'); } 
            else { document.getElementById('nextBtn').innerText = "Next"; document.getElementById('nextBtn').classList.replace('btn-admin', 'btn-student'); }
        }

        function navigateQuestion(direction) {
            const activeTest = allTests.find(t => t.id === activeStudentTestId);
            if (direction === 1 && currentQuestionIndex === activeTest.questions.length - 1) return submitTestEarly();
            currentQuestionIndex += direction; renderQuestion();
        }

        function submitTestEarly() {
            const unanswered = userAnswers.filter(ans => ans === null).length;
            if (unanswered > 0) { if(!confirm(`You have ${unanswered} unanswered questions. Submit anyway?`)) return; } 
            else { if(!confirm("Are you sure you want to submit to the cloud?")) return; }
            processTestResults();
        }

        function processTestResults() {
            clearInterval(testTimerInterval); 
            const activeTest = allTests.find(t => t.id === activeStudentTestId); const currentUser = userDatabase.find(u => u.id === currentUserId);
            let correctCount = 0; activeTest.questions.forEach((q, index) => { if (userAnswers[index] === q.correctIndex) correctCount++; });

            studentScores.push({ studentId: currentUser.id, studentName: currentUser.name, testId: activeTest.id, testName: activeTest.name, score: correctCount, total: activeTest.questions.length, date: new Date().toLocaleDateString() });
            saveData(); 

            document.getElementById('quizContainer').classList.add('hidden'); document.getElementById('resultContainer').classList.remove('hidden');
            document.getElementById('scoreDisplay').innerText = `${correctCount} / ${activeTest.questions.length}`;
            const percentage = Math.round((correctCount / activeTest.questions.length) * 100); document.getElementById('scorePercentage').innerText = `${percentage}% Accuracy`;
            buildReviewUI(activeTest);
        }

        function buildReviewUI(test) {
            const listDiv = document.getElementById('reviewList'); listDiv.innerHTML = '';
            test.questions.forEach((q, qIndex) => {
                const userAns = userAnswers[qIndex]; const actualAns = q.correctIndex; const isCorrect = userAns === actualAns;
                let html = `<div class="review-card"><p style="font-weight:bold; margin-top:0;">${isCorrect ? "‚úÖ" : "‚ùå"} Q${qIndex + 1}: ${q.question}</p>`;
                if(q.image) html += `<img src="${q.image}" class="responsive-img" style="max-height: 100px; display: block; margin: 10px 0; border-radius: 4px; cursor:zoom-in;" onclick="openLightbox(this.src)">`;
                q.options.forEach((opt, optIndex) => {
                    let c = 'review-option'; let s = "";
                    if (optIndex === actualAns) { c += ' review-correct'; s = " (Correct)"; } else if (optIndex === userAns) { c += ' review-wrong'; s = " (Your Answer)"; }
                    html += `<div class="${c}">${opt}${s}</div>`;
                });
                if (userAns === null) html += `<p style="color:#dc3545; font-weight:bold; font-size:13px;">You left this blank.</p>`;
                listDiv.innerHTML += html + `</div>`;
            });
        }
    </script>
</body>
</html>
